{% extends 'base.html' %}
{% load static %}
{% block title %}PlanMyTrip - Detalles Viaje{% endblock %}
{% block src_css %}{% static 'css/detalles_viaje.css' %}{% endblock %}
{% block style %}
    .parallax-map {
    height: 400px;
    background-attachment: fixed;
    background-position: center;
    background-repeat: no-repeat;
    background-size: cover;
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    }

    .map-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    }

    /* Diseño de tarjetas */
    .info-card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: transform 0.3s;
    height: 100%;
    }

    .info-card:hover {
    transform: translateY(-5px);
    }

    .card-header-custom {
    background: linear-gradient(135deg, #3f51b5 0%, #2196F3 100%);
    color: white;
    border-radius: 10px 10px 0 0 !important;
    }

    /* Diseño de pestañas */
    .nav-tabs .nav-link {
    border: none;
    color: #495057;
    font-weight: 500;
    }

    .nav-tabs .nav-link.active {
    color: #3f51b5;
    border-bottom: 3px solid #3f51b5;
    background: transparent;
    }

    /* Diseño de actividades */
    .activity-item {
    border-left: 3px solid #3f51b5;
    transition: all 0.3s;
    }

    .activity-item:hover {
    background-color: #f8f9fa;
    }

    /* Quick actions */
    .quick-action {
    transition: all 0.3s;
    border-radius: 8px;
    }

    .quick-action:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    /* Badges personalizados */
    .priority-badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
    }
    </style>
{% endblock %}

{% block content %}
    <div class="wrapper d-flex flex-column min-vh-100">

        {% if messages %}
            {{ message }}
        {% endif %}

        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top" style="z-index: 1030;">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold text-primary d-flex align-items-center" href="{% url 'viajes:inicio' %}">
                    <img src="{% static 'imagenes/logo.png' %}" width="45" height="45" alt="logo"
                         class="me-2 rounded-circle">
                    <span class="brand-text fs-4">PlanMyTrip</span>
                </a>

                <div class="d-flex align-items-center ms-auto">
                    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                        <ul class="navbar-nav me-4">
                            <li class="nav-item mx-2">
                                <a class="nav-link" href="{% url 'viajes:inicio' %}" style="color: #495057;">Página
                                    Principal</a>
                            </li>
                            <li class="nav-item mx-2">
                                <a class="nav-link" href="{% url 'viajes:viajes_publicos' %}" style="color: #495057;">Ideas
                                    de Viajes</a>
                            </li>
                        </ul>
                    </div>

                    <!-- Notificaciones -->
                    <div class="dropdown me-3">
                        <a href="#" class="position-relative text-dark btn btn-outline-light rounded-circle p-2"
                           data-bs-toggle="dropdown" aria-expanded="false" data-bs-toggle="tooltip"
                           title="Notificaciones">
                            <i class="fas fa-bell"></i>
                            {% if notificaciones_sin_leer_count > 0 %}
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                            {{ notificaciones_sin_leer_count }}
                        </span>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0"
                            style="border-radius: 12px; z-index: 1050;">
                            <li class="dropdown-header text-primary fw-bold">Notificaciones recientes</li>
                            {% for notificacion in ultimas_notificaciones %}
                                {% if notificacion.leido == False %}
                                    <li>
                                        <a class="dropdown-item d-flex justify-content-between align-items-start py-2"
                                           href="{% url 'viajes:notificacion_redireccion' notificacion.pk %}">
                                            <div>
                                                <div class="notification-text">{{ notificacion.mensaje }}</div>
                                                <small class="text-muted">{{ notificacion.fecha_creacion|timesince }}</small>
                                            </div>
                                            <span class="badge bg-primary rounded-pill">nuevo</span>
                                        </a>
                                    </li>
                                {% endif %}
                            {% empty %}
                                <li><a class="dropdown-item text-muted">No hay nuevas notificaciones</a></li>
                            {% endfor %}
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <a href="{% url 'viajes:notificaciones' %}"
                                   class="dropdown-item text-center text-primary fw-bold">
                                    Ver todas
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- Menú de usuario -->
                    <div class="dropdown">
                        <a href="#" class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle"
                           id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="





                                    {% if user.foto_perfil %}{{ user.foto_perfil.url }}{% else %}{% static 'imagenes/default-pic.png' %}{% endif %}"
                                 alt="Foto de perfil" width="40" height="40" class="rounded-circle me-2 avatar-glow">
                            <div class="d-none d-md-block">
                                <strong class="text-dark">{{ user.username }}</strong>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0"
                            style="border-radius: 12px; z-index: 1050;">
                            <li><a class="dropdown-item py-2" href="{% url 'viajes:ajustes_usuario' %}">
                                <i class="fas fa-user-cog me-2 text-primary"></i>Ajustes</a></li>
                            <li><a class="dropdown-item py-2" href="#">
                                <i class="fas fa-question-circle me-2 text-primary"></i>Ayuda</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <form action="{% url 'viajes:logout' %}" method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item py-2 text-danger">
                                        <i class="fas fa-sign-out-alt me-2"></i>Cerrar sesión
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        {% if es_colaborador or es_creador %}
            <!-- Quick Actions -->
            <div class="container-fluid py-3 bg-light sticky-top" style="z-index: 1020; top: 56px;">
                <div class="container">
                    <div class="row g-3 justify-content-center">
                        <div class="col-md-auto col-6" style="min-width: 140px;">
                            <a href="{% url 'viajes:crear_viaje' %}"
                               class="quick-action card text-center p-3 bg-white text-decoration-none h-100"
                               data-bs-toggle="modal"
                               data-bs-target="#crearViajeModal">
                                <div class="text-primary mb-2">
                                    <i class="fas fa-plus-circle fa-2x"></i>
                                </div>
                                <h6 class="mb-0 small fw-bold">Nuevo Viaje</h6>
                            </a>
                        </div>
                        <div class="col-md-auto col-6" style="min-width: 140px;">
                            <a href="#" class="quick-action card text-center p-3 bg-white text-decoration-none h-100"
                               data-bs-toggle="modal"
                               data-bs-target="#agregarColaboradorModal">
                                <div class="text-primary mb-2">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                                <h6 class="mb-0 small fw-bold">Invitar Amigos</h6>
                            </a>
                        </div>
                        <div class="col-md-auto col-6" style="min-width: 140px;">
                            <a href="#" class="quick-action card text-center p-3 bg-white text-decoration-none h-100"
                               data-bs-toggle="modal"
                               data-bs-target="#agregarPagoModal">
                                <div class="text-primary mb-2">
                                    <i class="fas fa-money-bill-wave fa-2x"></i>
                                </div>
                                <h6 class="mb-0 small fw-bold">Agregar Pago</h6>
                            </a>
                        </div>
                        <div class="col-md-auto col-6" style="min-width: 140px;">
                            <a href="#" class="quick-action card text-center p-3 bg-white text-decoration-none h-100"
                               data-bs-toggle="modal"
                               data-bs-target="#deudasModal">
                                <div class="text-primary mb-2">
                                    <i class="fas fa-balance-scale fa-2x"></i>
                                </div>
                                <h6 class="mb-0 small fw-bold">Deudas</h6>
                            </a>
                        </div>
                        <div class="col-md-auto col-6" style="min-width: 140px;">
                            <a href="{% url 'viajes:editar_viaje' viaje.pk %}"
                               class="quick-action card text-center p-3 bg-white text-decoration-none h-100">
                                <div class="text-primary mb-2">
                                    <i class="fas fa-cog fa-2x"></i>
                                </div>
                                <h6 class="mb-0 small fw-bold">Ajustes</h6>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <main class="flex-grow-1 py-4">
            <div class="container">
                <!-- Encabezado del viaje -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="mb-1">{{ viaje.nombre }}</h1>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-calendar-alt text-muted me-2"></i>
                            <span class="text-muted">
                            {{ viaje.fecha_inicio|date:"d/m/Y" }} - {{ viaje.fecha_fin|date:"d/m/Y" }}
                        </span>
                        </div>
                    </div>
                    <span class="badge bg-{% if viaje.estado == 'ACTIVO' %}success{% else %}secondary{% endif %} py-2 px-3">
                    {{ viaje.get_estado_display }}
                </span>
                </div>

                <!-- Pestañas principales -->
                <ul class="nav nav-tabs mb-4" id="viajeTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab"
                                data-bs-target="#overview" type="button" role="tab">
                            <i class="fas fa-info-circle me-2"></i>Resumen
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="activities-tab" data-bs-toggle="tab" data-bs-target="#activities"
                                type="button" role="tab">
                            <i class="fas fa-list-check me-2"></i>Actividades
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses"
                                type="button" role="tab">
                            <i class="fas fa-money-bill-wave me-2"></i>Gastos
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="viajeTabsContent">
                    <!-- Pestaña de Resumen -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="row">
                            <!-- Información del viaje -->
                            <div class="col-lg-6 mb-4">
                                <div class="info-card card h-100">
                                    <div class="card-header card-header-custom">
                                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información del Viaje
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <h6><i class="fas fa-map-marker-alt text-primary me-2"></i>Destino</h6>
                                            <p>{{ viaje.destino.nombre }}, {{ viaje.destino.pais }}</p>
                                        </div>

                                        <div class="mb-3">
                                            <h6><i class="fas fa-calendar-day text-primary me-2"></i>Fechas</h6>
                                            <p>
                                                <span class="fw-bold">Inicio:</span> {{ viaje.fecha_inicio|date:"d/m/Y" }}<br>
                                                <span class="fw-bold">Fin:</span> {{ viaje.fecha_fin|date:"d/m/Y" }}
                                            </p>
                                        </div>

                                        {% if viaje.presupuesto_total %}
                                            <div class="mb-3">
                                                <h6><i class="fas fa-money-bill-wave text-primary me-2"></i>Presupuesto
                                                </h6>
                                                <p>{{ viaje.presupuesto_total }} €</p>
                                            </div>
                                        {% endif %}

                                        <!-- Mapa -->
                                        <div class="mt-4">
                                            <h6><i class="fas fa-map text-primary me-2"></i>Ubicación</h6>
                                            <div class="parallax-map" id="map">
                                                <div class="map-overlay">
                                                    <h4 class="mb-0">{{ viaje.destino.nombre }}</h4>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Participantes -->
                            <div class="col-lg-6">
                                <div class="info-card card h-100 mb-4">
                                    <div class="card-header card-header-custom">
                                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Participantes</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-4">
                                            <h6><i class="fas fa-crown text-warning me-2"></i>Creador</h6>
                                            <div class="d-flex align-items-center mb-3">
                                                <img src="




                                                        {% if viaje.creador.foto_perfil %}{{ viaje.creador.foto_perfil.url }}{% else %}{% static 'imagenes/default-pic.png' %}{% endif %}"
                                                     class="rounded-circle me-3" width="40" height="40">
                                                <span>{{ viaje.creador.username }}</span>
                                            </div>
                                        </div>

                                        <div>
                                            <h6><i class="fas fa-user-friends text-primary me-2"></i>Colaboradores</h6>
                                            {% if viaje.colaboradores.all %}
                                                <div class="row">
                                                    {% for colaborador in viaje.colaboradores.all %}
                                                        <div class="col-md-6 mb-3">
                                                            <div class="d-flex align-items-center">
                                                                <img src="




                                                                        {% if colaborador.foto_perfil %}{{ colaborador.foto_perfil.url }}{% else %}{% static 'imagenes/default-pic.png' %}{% endif %}"
                                                                     class="rounded-circle me-3" width="40" height="40">
                                                                <div>
                                                                    <div>{{ colaborador.username }}</div>
                                                                    {% if es_creador %}
                                                                        <a href="#"
                                                                           class="text-danger small eliminar-colaborador"
                                                                           data-id="{{ colaborador.id }}"
                                                                           data-tipo="colaborador"
                                                                           data-viaje-id="{{ viaje.id }}">
                                                                            <i class="fas fa-trash-alt me-1"></i>Eliminar
                                                                        </a>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <p class="text-muted">No hay colaboradores añadidos</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña de Actividades -->
                    <div class="tab-pane fade" id="activities" role="tabpanel">
                        <div class="row">
                            <!-- Columna de Actividades Planificadas -->
                            <div class="col-md-8">
                                <div class="info-card card mb-4" id="actividades-pdf">
                                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-list-check me-2"></i>Actividades Planificadas
                                        </h5>
                                        <div>
                                            {% if viaje.actividades.all %}
                                                <button id="generarItinerarioBtn"
                                                        class="btn btn-light btn-sm text-danger me-2">
                                                    <i class="fas fa-file-pdf me-1"></i> Descargar PDF
                                                </button>
                                            {% endif %}
                                            {% if es_creador or es_colaborador %}
                                                <a href="{% url 'viajes:agregar_actividad' viaje.pk %}"
                                                   class="btn btn-light btn-sm"
                                                   data-bs-toggle="modal"
                                                   data-bs-target="#agregarActividadModal">
                                                    <i class="fas fa-plus me-1"></i> Añadir
                                                </a>
                                            {% else %}
                                                <a href="{% url 'viajes:agregar_actividad' viaje.pk %}"
                                                   class="btn btn-light btn-sm disabled"
                                                   data-bs-toggle="modal"
                                                   data-bs-target="#agregarActividadModal">
                                                    <i class="fas fa-plus me-1"></i> Añadir
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                        {% if viaje.actividades.all %}
                                            <div class="list-group list-group-flush">
                                                {% for actividad in viaje.actividades.all %}
                                                    <div class="list-group-item activity-item mb-2">
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-grow-1">
                                                                <div class="d-flex align-items-center mb-1">
                                                                    <a href="{% url 'viajes:detalles_actividad' actividad.pk %}"
                                                                       class="fw-bold text-decoration-none me-2">
                                                                        {{ actividad.titulo }}
                                                                    </a>
                                                                    <span class="badge priority-badge {% if actividad.prioridad == 'ALTA' %}bg-danger{% elif actividad.prioridad == 'MEDIA' %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                                    {{ actividad.get_prioridad_display }}
                                                </span>
                                                                </div>
                                                                <div class="d-flex align-items-center text-muted small">
                                                                    <i class="fas fa-calendar-alt me-1"></i>
                                                                    <span class="me-3">{{ actividad.fecha_hora|date:"d/m/Y H:i" }}</span>
                                                                    <i class="fas fa-map-marker-alt me-1"></i>
                                                                    <span>{{ actividad.ubicacion|default:"Sin ubicación" }}</span>
                                                                </div>
                                                            </div>
                                                            <div class="d-flex">
                                                                <!-- Botón Like -->
                                                                <a href="#" class="like-btn me-2"
                                                                   data-id="{{ actividad.pk }}">
                                                                    <i class="{% if actividad.pk in liked_actividades %}fa-solid fa-heart{% else %}fa-regular fa-heart{% endif %}"
                                                                       style="font-size:1.1rem; color: {% if actividad.pk in liked_actividades %}red{% else %}inherit{% endif %};"></i>
                                                                </a>
                                                                <!-- Contador -->
                                                                <a href="#"
                                                                   class="likes-count badge bg-light text-dark me-2"
                                                                   data-id="{{ actividad.pk }}"
                                                                   data-bs-toggle="modal"
                                                                   data-bs-target="#likesModal">
                                                                    {{ actividad.me_gustas.count }}
                                                                </a>
                                                                {% if es_creador or es_colaborador %}
                                                                <a href="{% url 'viajes:editar_actividad' actividad.pk %}"
                                                                   class="btn btn-sm btn-outline-primary me-2">
                                                                    <i class="fas fa-edit"></i>
                                                                </a>
                                                                <a href="#"
                                                                   class="btn btn-sm btn-outline-danger eliminar-actividad"
                                                                   data-id="{{ actividad.pk }}" data-tipo="actividad">
                                                                    <i class="fas fa-trash-alt"></i>
                                                                </a>
                                                                {% else %}
                                                                <a href="{% url 'viajes:editar_actividad' actividad.pk %}"
                                                                   class="btn btn-sm btn-outline-primary me-2 disabled">
                                                                    <i class="fas fa-edit"></i>
                                                                </a>
                                                                <a href="#"
                                                                   class="btn btn-sm btn-outline-danger eliminar-actividad disabled"
                                                                   data-id="{{ actividad.pk }}" data-tipo="actividad">
                                                                    <i class="fas fa-trash-alt"></i>
                                                                </a>
                                                            {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <div class="text-center py-4">
                                                <i class="fas fa-calendar-plus fa-3x text-muted mb-3"></i>
                                                <h5 class="text-muted">No hay actividades planificadas</h5>
                                                {% if es_creador or es_colaborador %}
                                                    <a href="{% url 'viajes:agregar_actividad' viaje.pk %}"
                                                       class="btn btn-primary mt-3">
                                                        <i class="fas fa-plus-circle me-1"></i> Crear primera actividad
                                                    </a>
                                                {% else %}
                                                    <a href="{% url 'viajes:agregar_actividad' viaje.pk %}"
                                                       class="btn btn-primary mt-3 disabled">
                                                        <i class="fas fa-plus-circle me-1"></i> Crear primera actividad
                                                    </a>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Columna de Sugerencias -->
                            <div class="col-md-4">
                                <div class="info-card card mb-4">
                                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-wand-magic-sparkles me-2"></i>Sugerencias
                                        </h5>
                                        {# <button id="recargar-sugerencias" class="btn btn-sm btn-outline-light"#}
                                        {# title="Recargar sugerencias">#}
                                        {# <i class="fas fa-rotate-right "></i>#}
                                        {# </button>#}
                                        <a href="{% url 'viajes:detalles_viaje' viaje.pk %}" id="recargar-sugerencias"
                                           class="btn btn-sm btn-outline-light"
                                           title="Recargar sugerencias">
                                            <i class="fas fa-rotate-right"></i>
                                        </a>
                                    </div>
                                    <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
                                        {% if sugerencias %}
                                            <div class="list-group list-group-flush">
                                                <!-- Primera sugerencia (introductoria) -->
                                                <div class="list-group-item py-3 bg-light text-center text-primary">
                                                    <p class="mb-0">{{ sugerencias.0|safe }}</p>
                                                </div>

                                                <!-- Sugerencias de actividades -->
                                                {% for s in sugerencias|slice:"1:" %}
                                                    <div class="list-group-item py-3">
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div class="d-flex align-items-start">
                                                                <i class="fas fa-map-pin text-danger mt-1 me-3"></i>
                                                                <div>
                                                                    {{ s|safe }}
                                                                </div>
                                                            </div>
                                                            {% if es_creador or es_colaborador %}
                                                                <button class="btn btn-sm btn-outline-primary agregar-sugerencia"
                                                                        data-sugerencia="{{ s|striptags }}"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#agregarActividadModal"
                                                                        title="Añadir como actividad">
                                                                    <i class="fas fa-plus"></i>
                                                                </button>
                                                            {% else %}
                                                                <button class="btn btn-sm btn-outline-primary agregar-sugerencia"
                                                                        data-sugerencia="{{ s }}"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#agregarActividadModal"
                                                                        data-titulo="{{ s }}"
                                                                        title="Añadir como actividad" disabled>
                                                                    <i class="fas fa-plus"></i>
                                                                </button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <p class="text-muted p-3">No hay sugerencias disponibles.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        const actividadesData = [
                            {% for actividad in viaje.actividades.all|dictsort:"fecha_hora" %}
                                {
                                    fecha: '{{ actividad.fecha_hora|date:"d/m/Y H:i" }}',
                                    titulo: '{{ actividad.titulo|escapejs }}',
                                    descripcion: '{{ actividad.descripcion|default:"(sin descripción)"|escapejs }}'
                                }{% if not forloop.last %},{% endif %}
                            {% empty %}
                                // si no hay actividades, el array queda vacío
                            {% endfor %}
                        ];

                        $(document).ready(function () {
                            $('.agregar-sugerencia').click(function () {
                                const titulo = $(this).data('titulo');
                                $('#id_titulo').val(titulo);
                                $('#id_descripcion').val(titulo);
                            });
                        });
                    </script>

                    <!-- Pestaña de Gastos -->
                    <div class="tab-pane fade" id="expenses" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="info-card card mb-4">
                                    <div class="card-header card-header-custom">
                                        <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Resumen de Gastos
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        {% if deudas %}
                                            <div class="table-responsive">
                                                <table class="table">
                                                    <thead>
                                                    <tr>
                                                        <th>Participante</th>
                                                        <th class="text-end">Deuda</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for username, cantidad in deudas.items %}
                                                        <tr>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <img src="
                                                                            {% if usuario.foto_perfil %}{{ usuario.foto_perfil.url }}{% else %}{% static 'imagenes/default-pic.png' %}{% endif %}"
                                                                         class="rounded-circle me-2" width="30"
                                                                         height="30">
                                                                    <span>{{ username }}</span>
                                                                </div>
                                                            </td>
                                                            <td class="text-end fw-bold text-danger">{{ cantidad }}€</td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>

                                            <div class="d-flex justify-content-between mt-4">
                                                {% if es_colaborador or es_creador %}
                                                    <a href="{% url 'viajes:lista_gastos' viaje.pk %}"
                                                       class="btn btn-outline-secondary">
                                                        <i class="fas fa-list me-1"></i> Ver todos los gastos
                                                    </a>
                                                    <button class="btn btn-primary" data-bs-toggle="modal"
                                                            data-bs-target="#agregarPagoModal">
                                                        <i class="fas fa-money-bill-wave me-1"></i> Agregar Pago
                                                    </button>
                                                {% else %}
                                                    <a href="{% url 'viajes:lista_gastos' viaje.pk %}"
                                                       class="btn btn-outline-secondary disabled">
                                                        <i class="fas fa-list me-1"></i> Ver todos los gastos
                                                    </a>
                                                    <button class="btn btn-primary" data-bs-toggle="modal"
                                                            data-bs-target="#agregarPagoModal" disabled>
                                                        <i class="fas fa-money-bill-wave me-1"></i> Agregar Pago
                                                    </button>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <div class="text-center py-4">
                                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                                <h5 class="text-success">No hay deudas pendientes</h5>
                                                <p class="text-muted">Todos los gastos están equilibrados entre los
                                                    participantes.</p>
                                                {% if es_colaborador or es_creador %}
                                                    <button class="btn btn-primary mt-3" data-bs-toggle="modal"
                                                            data-bs-target="#agregarPagoModal">
                                                        <i class="fas fa-money-bill-wave me-1"></i> Registrar nuevo
                                                        gasto
                                                    </button>
                                                {% else %}
                                                    <button class="btn btn-primary mt-3" data-bs-toggle="modal"
                                                            data-bs-target="#agregarPagoModal" disabled>
                                                        <i class="fas fa-money-bill-wave me-1"></i> Registrar
                                                        nuevo
                                                        gasto
                                                    </button>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="info-card card">
                                    <div class="card-header card-header-custom">
                                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Estadísticas</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if viaje.presupuesto_total %}
                                            <div class="mb-4">
                                                <h6>Presupuesto restante</h6>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-success" role="progressbar"
                                                         style="width: 75%;"
                                                         aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
                                                        75%
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                        <div>
                                            <h6>Gastos por categoría</h6>
                                            {% if categorias %}
                                                <div>
                                                    <canvas id="graficoGastosPorCategoria" width="300"
                                                            height="300"></canvas>
                                                </div>
                                                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                                                <script>
                                                    const ctx = document.getElementById('graficoGastosPorCategoria').getContext('2d');
                                                    const categorias = {{ categorias|safe }};
                                                    const cantidades = {{ cantidades|safe }};

                                                    new Chart(ctx, {
                                                        type: 'pie',
                                                        data: {
                                                            labels: categorias,
                                                            datasets: [{
                                                                label: 'Gastos por categoría',
                                                                data: cantidades,
                                                                backgroundColor: [
                                                                    '#FF6384', '#36A2EB', '#FFCE56', '#81C784', '#BA68C8', '#4DD0E1'
                                                                ],
                                                                hoverOffset: 8
                                                            }]
                                                        },
                                                        options: {
                                                            plugins: {
                                                                tooltip: {
                                                                    callbacks: {
                                                                        label: function (context) {
                                                                            return `${context.label}: ${context.formattedValue}€`;
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    });
                                                </script>
                                            {% else %}
                                                <div class="text-center py-3">
                                                    <i class="fas fa-chart-pie fa-3x text-muted"></i>
                                                    <p class="text-muted mt-2">Aún no hay gastos registrados.</p>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% if es_creador or es_colaborador %}
                    <!-- Botones de acción -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'viajes:inicio' %}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-1"></i> Volver al inicio
                        </a>
                        <div>
                            <a href="{% url 'viajes:editar_viaje' viaje.pk %}" class="btn btn-primary me-2">
                                <i class="fas fa-edit me-1"></i> Editar viaje
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer py-5"
                style="background-color: #f8f9fa; color: #495057; border-top: 1px solid #e1e5ee;">
            <div class="container">
                <div class="row">
                    <div class="col-lg-4 mb-4 mb-lg-0">
                        <h5 class="mb-3" style="color: #4692ff;">
                            <img src="{% static 'imagenes/logo.png' %}" width="40" height="40" alt="logo"
                                 class="me-2">
                            PlanMyTrip
                        </h5>
                        <p>La mejor manera de planificar viajes en grupo con tus amigos.</p>
                    </div>
                    <div class="col-lg-2 col-md-6 mb-4 mb-md-0">
                        <h5 class="mb-3" style="color: #4692ff;">Enlaces</h5>
                        <ul class="list-unstyled">
                            <li class="mb-2"><a href="#funcionalidades" class="text-decoration-none"
                                                style="color: #495057;">Funcionalidades</a></li>
                            <li class="mb-2"><a href="#testimonios" class="text-decoration-none"
                                                style="color: #495057;">Testimonios</a>
                            </li>
                            <li><a href="{% url 'viajes:login' %}" class="text-decoration-none"
                                   style="color: #495057;">Iniciar
                                sesión</a></li>
                        </ul>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4 mb-md-0">
                        <h5 class="mb-3" style="color: #4692ff;">Legal</h5>
                        <ul class="list-unstyled">
                            <li class="mb-2"><a href="#" class="text-decoration-none" style="color: #495057;">Términos
                                de
                                uso</a></li>
                            <li class="mb-2"><a href="#" class="text-decoration-none" style="color: #495057;">Política
                                de
                                privacidad</a></li>
                            <li><a href="#" class="text-decoration-none" style="color: #495057;">Cookies</a></li>
                        </ul>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <h5 class="mb-3" style="color: #4692ff;">Síguenos</h5>
                        <div class="d-flex gap-3">
                            <a href="#" class="text-decoration-none" style="color: #495057;"><i
                                    class="fab fa-facebook-f fa-lg"></i></a>
                            <a href="#" class="text-decoration-none" style="color: #495057;"><i
                                    class="fab fa-twitter fa-lg"></i></a>
                            <a href="#" class="text-decoration-none" style="color: #495057;"><i
                                    class="fab fa-instagram fa-lg"></i></a>
                            <a href="#" class="text-decoration-none" style="color: #495057;"><i
                                    class="fab fa-linkedin-in fa-lg"></i></a>
                        </div>
                    </div>
                </div>
                <hr class="my-4" style="border-color: rgba(0,0,0,0.1);">
                <div class="text-center">
                    <p class="mb-0 small">&copy; 2025 PlanMyTrip. Todos los derechos reservados.</p>
                </div>
            </div>
        </footer>

        <!-- Modal para agregar colaboradores -->
        <div class="modal fade" id="agregarColaboradorModal" tabindex="-1"
             aria-labelledby="agregarColaboradorModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="agregarColaboradorModalLabel">Agregar Colaborador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="agregarColaboradorForm">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="usuario_id" class="form-label">Añade un colaborador</label>
                                <select class="form-select" id="usuario_id" name="usuario_id" required>
                                    <option selected disabled value="">-- Selecciona un amigo --</option>
                                    {% for amigo in amigos %}
                                        <option value="{{ amigo.id }}">{{ amigo.username }}</option>
                                    {% empty %}
                                        <option disabled>No tienes amigos aún</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback" id="username-error"></div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="agregarColaboradorBtn">Agregar</button>
                    </div>
                </div>
            </div>
        </div>


        <!--Modal para mensaje de confirmación al eliminar actividad o colaborador -->
        <div class="modal fade" id="confirmarEliminarModal" tabindex="-1"
             aria-labelledby="confirmarEliminarModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="confirmarEliminarModalLabel">Confirmar eliminación</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body" id="modal-body-text">

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" id="btnConfirmarEliminar" class="btn btn-danger">Eliminar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para Agregar Pago -->
        <div class="modal fade" id="agregarPagoModal" tabindex="-1" aria-labelledby="agregarPagoModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="agregarPagoModalLabel">Agregar Gasto</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="agregarPagoForm" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="cantidad" class="form-label">Cantidad (€)</label>
                                        <input type="number" step="0.01" class="form-control" id="cantidad"
                                               name="cantidad" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="descripcion" class="form-label">Descripción</label>
                                        <input type="text" class="form-control" id="descripcion" name="descripcion"
                                               required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="categoria" class="form-label">Categoría</label>
                                        <select class="form-select" id="categoria" name="categoria" required>
                                            <option value="">Selecciona una categoría</option>
                                            <option value="ALOJAMIENTO">Alojamiento</option>
                                            <option value="COMIDA">Comida</option>
                                            <option value="TRANSPORTE">Transporte</option>
                                            <option value="ACTIVIDADES">Actividades</option>
                                            <option value="OTROS" selected>Otros</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="comprobante" class="form-label">Comprobante (opcional)</label>
                                        <input type="file" class="form-control" id="comprobante" name="comprobante"
                                               accept="image/*">
                                        <small class="text-muted">Sube una foto del ticket o factura.</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">¿Con quién compartes este gasto?</label>
                                        <div class="border p-2 rounded">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       name="participantes" value="{{ viaje.creador.id }}"
                                                       id="participante_creador" checked>
                                                <label class="form-check-label" for="participante_creador">
                                                    {{ viaje.creador.username }}
                                                </label>
                                            </div>
                                            {% for colaborador in viaje.colaboradores.all %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox"
                                                           name="participantes" value="{{ colaborador.id }}"
                                                           id="participante_{{ colaborador.id }}" checked>
                                                    <label class="form-check-label"
                                                           for="participante_{{ colaborador.id }}">
                                                        {{ colaborador.username }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <small class="text-muted">Desmarca a quienes no participen en este
                                            gasto.</small>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="agregarPagoBtn">
                            <i class="fas fa-save me-1"></i> Registrar Gasto
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Modal para Ver Deudas Agrupadas -->
        <div class="modal fade" id="deudasModal" tabindex="-1" aria-labelledby="deudasModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deudasModalLabel">Resumen de Deudas</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        {% if deudas_agrupadas %}
                            <ul class="list-group list-group-flush">
                                {% for d in deudas_agrupadas %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            {% with deudor_id=d.deudor %}
                                                {% for u in viaje.colaboradores.all %}
                                                    {% if u.id == deudor_id %}
                                                        <img src="









                                                                {% if u.foto_perfil %}{{ u.foto_perfil.url }}{% else %}{% static 'imagenes/default-pic.png' %}{% endif %}"
                                                             class="rounded-circle me-2" width="30" height="30">
                                                    {% endif %}
                                                {% endfor %}
                                                {% if viaje.creador.id == deudor_id %}
                                                    <img src="









                                                            {% if viaje.creador.foto_perfil %}{{ viaje.creador.foto_perfil.url }}{% else %}{% static 'imagenes/default-pic.png' %}{% endif %}"
                                                         class="rounded-circle me-2" width="30" height="30">
                                                {% endif %}
                                            {% endwith %}
                                            <span>
                                                    <strong>{{ d.deudor__username }}</strong>
                                                    debe
                                                    <strong>{{ d.total_deuda|floatformat:2 }}€</strong>
                                                    a
                                                    <strong>{{ d.gasto__pagador__username }}</strong>
                                                </span>
                                        </div>
                                        <span class="badge bg-danger rounded-pill">
                                                {{ d.total_deuda|floatformat:2 }}€
                                            </span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="alert alert-success mb-0">
                                <i class="fas fa-check-circle me-2"></i>No hay deudas pendientes.
                            </div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para mostrar los likes -->
        <div class="modal fade" id="likesModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">A quienes les gustó</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <ul id="likes-list" class="list-unstyled mb-0">

                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para crear viaje -->
        <div class="modal fade" id="crearViajeModal" tabindex="-1" aria-labelledby="crearViajeModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="crearViajeModalLabel">Crear Nuevo Viaje</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="crearViajeForm" method="post" action="{% url 'viajes:crear_viaje' %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="id_nombre" class="form-label">Nombre del Viaje</label>
                                <input type="text" class="form-control" id="id_nombre" name="nombre" required>
                            </div>
                            <div class="mb-3">
                                <label for="id_destino_nombre" class="form-label">Destino (ej: Cancún, México)</label>
                                <input type="text" class="form-control" id="id_destino_nombre" name="destino_nombre"
                                       required>
                                <div class="form-text">Escribe el nombre del destino y el país separados por coma</div>
                            </div>
                            <label for="id_categoria_destino" class="form-label">Tipo de destino</label>
                            <select class="form-select" id="id_categoria_destino" name="categoria_destino" required>
                                <option value="">Selecciona un tipo</option>
                                <option value="PLAYA">Playa</option>
                                <option value="CIUDAD">Ciudad</option>
                                <option value="MONTAÑA">Montaña</option>
                                <option value="RURAL">Rural</option>
                                <option value="CULTURAL">Cultural</option>
                            </select>
                            <div class="mb-3">
                                <label for="id_fecha_inicio" class="form-label">Fecha de inicio</label>
                                <input type="date" class="form-control" id="id_fecha_inicio" name="fecha_inicio"
                                       required>
                            </div>
                            <div class="mb-3">
                                <label for="id_fecha_fin" class="form-label">Fecha de fin</label>
                                <input type="date" class="form-control" id="id_fecha_fin" name="fecha_fin" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="submitViajeForm">Guardar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para agregar actividad -->
        <div class="modal fade" id="agregarActividadModal" tabindex="-1"
             aria-labelledby="agregarActividadModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="agregarActividadModalLabel">Nueva Actividad</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <form id="form-agregar-actividad"
                              method="post"
                              action="{% url 'viajes:agregar_actividad' viaje.pk %}">
                            {% csrf_token %}
                            <div id="actividad-errors" class="alert alert-danger d-none"></div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_titulo" class="form-label">Título</label>
                                        <input type="text" class="form-control" id="id_titulo" name="titulo" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_categoria" class="form-label">Categoría</label>
                                        <select class="form-select" id="id_categoria" name="categoria" required>
                                            <option value="GASTRONOMIA">Gastronomía</option>
                                            <option value="CULTURAL">Cultural</option>
                                            <option value="AVENTURA">Aventura</option>
                                            <option value="RELAX">Relax</option>
                                            <option value="OTROS" selected>Otros</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_fecha_hora" class="form-label">Fecha y hora</label>
                                        <input type="datetime-local" class="form-control" id="id_fecha_hora"
                                               name="fecha_hora" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_prioridad" class="form-label">Prioridad</label>
                                        <select class="form-select" id="id_prioridad" name="prioridad" required>
                                            <option value="BAJA">Baja</option>
                                            <option value="MEDIA" selected>Media</option>
                                            <option value="ALTA">Alta</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_ubicacion" class="form-label">Ubicación</label>
                                        <input type="text" class="form-control" id="id_ubicacion" name="ubicacion">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_coste_estimado" class="form-label">Coste estimado</label>
                                        <input type="number" step="0.01" min="0" class="form-control"
                                               id="id_coste_estimado" name="coste_estimado">
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="mb-3">
                                        <label for="id_descripcion" class="form-label">Descripción</label>
                                        <textarea class="form-control" rows="3"
                                                  id="id_descripcion" name="descripcion"></textarea>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="submitActividadForm">Guardar</button>
                    </div>
                </div>
            </div>
        </div>
        </main>

    </div>
    {% block scripts %}
        <script>
            let idAEliminar = null;
            let elementoAEliminar = null;
            let tipoAEliminar = null;
            let viajeId = null;
            let modalEliminar = null;
            let btnConfirmarEliminar = null;
            let modalBodyText = null;

            document.addEventListener('DOMContentLoaded', function () {
                modalEliminar = new bootstrap.Modal(document.getElementById('confirmarEliminarModal'));
                btnConfirmarEliminar = document.getElementById('btnConfirmarEliminar');
                modalBodyText = document.getElementById('modal-body-text');

                const viajeTabs = document.getElementById('viajeTabs');
                const tabButtons = viajeTabs.querySelectorAll('button[data-bs-toggle="tab"]');
                const storedTab = localStorage.getItem('activeTab');

                // Si hay una pestaña guardada, activarla
                if (storedTab) {
                    const tabToActivate = document.querySelector(`button[data-bs-target="${storedTab}"]`);
                    if (tabToActivate) {
                        const tabInstance = new bootstrap.Tab(tabToActivate);
                        tabInstance.show();
                    }
                }

                // Guardar la pestaña activa cuando se cambie
                tabButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const targetTab = this.getAttribute('data-bs-target');
                        localStorage.setItem('activeTab', targetTab);
                    });
                });

                // Asignar eventos de eliminación
                asignarEventosEliminar();

                // Manejar confirmación de eliminación
                btnConfirmarEliminar.addEventListener('click', function () {
                    let url = '';
                    if (tipoAEliminar === 'actividad') {
                        url = `/viajes/actividad/${idAEliminar}/eliminar/`;
                    } else if (tipoAEliminar === 'colaborador') {
                        url = `/viajes/viaje/${viajeId}/colaborador/${idAEliminar}/eliminar-colaborador/`;
                    }

                    // Mostrar estado de carga
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Eliminando...';

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Error en la respuesta del servidor');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                // Cierra el modal
                                modalEliminar.hide();

                                // Elimina el elemento del DOM si existe
                                if (elementoAEliminar) {
                                    elementoAEliminar.remove();
                                }

                                // Muestra mensaje de éxito
                                showAlert('success', data.message || 'Eliminado correctamente');

                                // Recarga la página para asegurar consistencia
                                setTimeout(() => {
                                    sessionStorage.setItem('activeTab', document.querySelector('.nav-link.active').getAttribute('data-bs-target'));
                                    window.location.reload();
                                }, 1000);
                            } else {
                                showAlert('danger', data.error || 'Error al eliminar');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showAlert('danger', 'Error en el servidor');
                        })
                        .finally(() => {
                            // Restablece el botón
                            btnConfirmarEliminar.disabled = false;
                            btnConfirmarEliminar.textContent = 'Eliminar';
                        });
                });

                // Agregar colaborador
                document.getElementById('agregarColaboradorBtn').addEventListener('click', async function () {
                    const select = document.getElementById('usuario_id');
                    const usuarioId = select.value;
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    if (!usuarioId) {
                        showAlert('danger', 'Por favor selecciona un amigo');
                        return;
                    }

                    // Deshabilita el botón para evitar múltiples clics
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Agregando...';

                    try {
                        const response = await fetch("{% url 'viajes:agregar_colaborador' viaje.id %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken,
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({usuario_id: usuarioId})
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || 'Error en el servidor');
                        }

                        if (data.success) {
                            // Cierra el modal
                            bootstrap.Modal.getInstance(document.getElementById('agregarColaboradorModal')).hide();

                            // Muestra mensaje de éxito
                            showAlert('success', data.message || 'Colaborador añadido correctamente');

                            // Recarga la página para mostrar los cambios
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            showAlert('danger', data.error || 'Error al agregar colaborador');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showAlert('danger', error.message || 'Error de conexión');
                    } finally {
                        // Vuelve a habilitar el botón
                        this.disabled = false;
                        this.textContent = 'Agregar';
                    }
                });


                // Registrar gasto
                document.getElementById('agregarPagoBtn').addEventListener('click', async function () {
                    const form = document.getElementById('agregarPagoForm');
                    const formData = new FormData(form);

                    if (!formData.get('cantidad') || !formData.get('descripcion') || !formData.get('categoria')) {
                        showAlert('danger', 'Completa los campos obligatorios');
                        return;
                    }

                    // Estado de carga
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

                    try {
                        const response = await fetch("{% url 'viajes:agregar_gasto' viaje.pk %}", {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || 'Error en el servidor');
                        }

                        if (data.success) {
                            // Cierra el modal
                            bootstrap.Modal.getInstance(document.getElementById('agregarPagoModal')).hide();

                            // Muestra mensaje de éxito
                            showAlert('success', data.message || 'Gasto registrado correctamente');

                            // Recarga la página
                            setTimeout(() => {
                                sessionStorage.setItem('activeTab', document.querySelector('.nav-link.active').getAttribute('data-bs-target'));
                                window.location.reload();
                            }, 1500);
                        } else {
                            if (data.errors) {
                                let errorMsg = '';
                                for (const [field, error] of Object.entries(data.errors)) {
                                    errorMsg += `${field}: ${error}\n`;
                                }
                                showAlert('danger', errorMsg);
                            } else {
                                showAlert('danger', data.error || 'Error desconocido');
                            }
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showAlert('danger', error.message || 'Error de conexión');
                    } finally {
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-save me-1"></i> Registrar Gasto';
                    }
                });

                // Sistema de likes
                document.querySelectorAll('.like-btn').forEach(btn => {
                    btn.addEventListener('click', async e => {
                        e.preventDefault();
                        const pk = btn.dataset.id;

                        try {
                            const resp = await fetch(
                                `{% url 'viajes:toggle_like' 0 %}`.replace('0', pk),
                                {
                                    method: 'POST',
                                    headers: {
                                        'X-CSRFToken': getCookie('csrftoken'),
                                        'Accept': 'application/json',
                                    },
                                }
                            );

                            const data = await resp.json();
                            const icon = btn.querySelector('i');

                            if (data.liked) {
                                icon.classList.remove('fa-regular');
                                icon.classList.add('fa-solid');
                                icon.style.color = 'red';
                            } else {
                                icon.classList.remove('fa-solid');
                                icon.classList.add('fa-regular');
                                icon.style.color = 'inherit';
                            }

                            document.querySelector(`.likes-count[data-id="${pk}"]`).textContent = data.count;
                        } catch (error) {
                            console.error('Error:', error);
                            showAlert('danger', 'Error al guardar tu like');
                        }
                    });
                });

                // Mostrar lista de likes
                document.querySelectorAll('.likes-count').forEach(link => {
                    link.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const pk = link.dataset.id;

                        try {
                            const resp = await fetch(`{% url 'viajes:actividad_likes' 0 %}`.replace('0', pk));
                            const data = await resp.json();
                            const ul = document.getElementById('likes-list');
                            ul.innerHTML = '';

                            if (data.usuarios && data.usuarios.length) {
                                data.usuarios.forEach(user => {
                                    const li = document.createElement('li');
                                    li.className = 'd-flex align-items-center mb-3 px-3';

                                    // Foto de perfil (con imagen por defecto si no hay)
                                    const fotoUrl = user.foto_perfil || '{% static "imagenes/default-pic.png" %}';

                                    // Nombre de usuario
                                    const username = user.username || 'Usuario';

                                    li.innerHTML = `
                        <img src="${fotoUrl}"
                             class="rounded-circle me-3"
                             width="40"
                             height="40"
                             style="object-fit: cover;"
                             onerror="this.src='{% static "imagenes/default-pic.png" %}'">
                        <span class="fw-medium">${username}</span>
                    `;

                                    ul.appendChild(li);
                                });
                            } else {
                                ul.innerHTML = '<li class="text-muted py-2 px-3">No hay likes aún</li>';
                            }

                            // Mostrar el modal usando Bootstrap
                            const modal = new bootstrap.Modal(document.getElementById('likesModal'));
                            modal.show();

                        } catch (error) {
                            console.error('Error:', error);
                            showAlert('danger', 'Error al cargar los likes');
                        }
                    });
                });

                // Mapbox
                if (document.getElementById('map')) {
                    mapboxgl.accessToken = 'pk.eyJ1IjoiYW5pdGFtdCIsImEiOiJjbTlpc29pb3EwNWxwMmtzYzQ0NmY1ZjFiIn0.4iAF_BAMHBlqMe7CDHWjyg';
                    const direccion = `{{ viaje.destino.nombre }}, {{ viaje.destino.pais }}`;

                    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(direccion)}.json?access_token=${mapboxgl.accessToken}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.features && data.features.length > 0) {
                                const [lng, lat] = data.features[0].center;
                                const map = new mapboxgl.Map({
                                    container: 'map',
                                    style: 'mapbox://styles/mapbox/streets-v11',
                                    center: [lng, lat],
                                    zoom: 10
                                });
                                new mapboxgl.Marker()
                                    .setLngLat([lng, lat])
                                    .setPopup(new mapboxgl.Popup().setText(direccion))
                                    .addTo(map);
                            } else {
                                document.getElementById('map').innerHTML = '<p class="text-muted">No se pudo localizar esta dirección.</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error al geocodificar:', error);
                            document.getElementById('map').innerHTML = '<p class="text-danger">No se pudo cargar el mapa.</p>';
                        });
                }

                // Modal para crear viaje rápido
                const crearViajeBtn = document.getElementById('submitViajeForm');
                if (crearViajeBtn) {
                    crearViajeBtn.addEventListener('click', async function (e) {
                        e.preventDefault();
                        const form = document.getElementById('crearViajeForm');
                        const formData = new FormData(form);

                        // Validación básica de fechas
                        const fechaInicio = new Date(formData.get('fecha_inicio'));
                        const fechaFin = new Date(formData.get('fecha_fin'));

                        if (fechaFin < fechaInicio) {
                            showAlert('danger', 'La fecha de fin no puede ser anterior a la fecha de inicio');
                            return;
                        }

                        // Estado de carga
                        this.disabled = true;
                        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

                        try {
                            const response = await fetch(form.action, {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            });

                            const data = await response.json();

                            if (!response.ok) {
                                throw new Error(data.error || 'Error en el servidor');
                            }

                            if (data.success) {
                                // Cierra el modal
                                bootstrap.Modal.getInstance(document.getElementById('crearViajeModal')).hide();

                                // Muestra mensaje de éxito
                                showAlert('success', data.message || '¡Viaje creado correctamente!');

                                // Recarga la página después de 1.5 segundos
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            } else {
                                // Manejo de errores de validación
                                if (data.errors) {
                                    // Limpia errores anteriores
                                    document.querySelectorAll('.is-invalid').forEach(el => {
                                        el.classList.remove('is-invalid');
                                    });
                                    document.querySelectorAll('.invalid-feedback').forEach(el => {
                                        el.remove();
                                    });

                                    // Muestra nuevos errores
                                    for (const [field, error] of Object.entries(data.errors)) {
                                        const input = document.querySelector(`[name="${field}"]`);
                                        const feedback = document.createElement('div');
                                        feedback.className = 'invalid-feedback';
                                        feedback.textContent = error;

                                        if (input) {
                                            input.classList.add('is-invalid');
                                            input.parentNode.appendChild(feedback);
                                        } else {
                                            showAlert('danger', error);
                                        }
                                    }
                                } else {
                                    showAlert('danger', data.error || 'Error al crear el viaje');
                                }
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            showAlert('danger', error.message || 'Error de conexión');
                        } finally {
                            this.disabled = false;
                            this.innerHTML = 'Guardar';
                        }
                    });

                    // Limpiar errores cuando el modal se cierra
                    document.getElementById('crearViajeModal').addEventListener('hidden.bs.modal', function () {
                        document.querySelectorAll('.is-invalid').forEach(el => {
                            el.classList.remove('is-invalid');
                        });
                        document.querySelectorAll('.invalid-feedback').forEach(el => {
                            el.remove();
                        });

                        // Resetear el formulario
                        document.getElementById('crearViajeForm').reset();
                    });
                }

                document.querySelectorAll('.agregar-sugerencia').forEach(button => {
                    button.addEventListener('click', function () {
                        const sugerencia = this.getAttribute('data-sugerencia');

                        // Limpiar el texto de formato
                        let textoLimpio = sugerencia.replace(/<\/?[^>]+(>|$)/g, "")
                            .replace(/\*\*/g, "")
                            .trim();

                        // Separar título y descripción si hay dos puntos
                        let [titulo, ...descripcionParts] = textoLimpio.split(':');
                        let descripcion = descripcionParts.join(':').trim();

                        document.getElementById('id_titulo').value = titulo.trim();
                        document.getElementById('id_descripcion').value = descripcion || titulo.trim();
                    });
                });

                //Agregar actividad
                const submitActBtn = document.getElementById('submitActividadForm');
                if (submitActBtn) {
                    const formAct = document.getElementById('form-agregar-actividad');
                    const modalActEl = document.getElementById('agregarActividadModal');
                    const modalAct = new bootstrap.Modal(modalActEl);
                    const errorsAct = document.getElementById('actividad-errors');
                    const listaAct = document.getElementById('lista-actividades');

                    submitActBtn.addEventListener('click', () => formAct.requestSubmit());

                    formAct.addEventListener('submit', e => {
                        e.preventDefault();
                        errorsAct.classList.add('d-none');
                        errorsAct.innerHTML = '';

                        const data = new FormData(formAct);

                        fetch(formAct.action, {
                            method: 'POST',
                            headers: {'X-Requested-With': 'XMLHttpRequest'},
                            body: data
                        })
                            .then(res => {
                                if (!res.ok) throw res;
                                return res.json();
                            })
                            .then(json => {
                                // Inserta el HTML renderizado por la view
                                if (json.html) {
                                    listaAct.insertAdjacentHTML('afterbegin', json.html);
                                    asignarEventosEliminar();
                                }
                                modalAct.hide();
                                formAct.reset();

                                // Toast de éxito
                                const toastEl = document.createElement('div');
                                toastEl.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
                                toastEl.style = 'top:20px;right:20px;z-index:1200';
                                toastEl.setAttribute('role', 'alert');
                                toastEl.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${json.message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto"
                  data-bs-dismiss="toast"></button>
        </div>`;
                                document.body.appendChild(toastEl);
                                new bootstrap.Toast(toastEl, {delay: 2500}).show();

                                setTimeout(() => {
                                    sessionStorage.setItem('activeTab', document.querySelector('.nav-link.active').getAttribute('data-bs-target'));
                                    window.location.reload();
                                }, 1500);
                            })
                            .catch(err => {
                                if (err.json) {
                                    err.json().then(j => {
                                        let html = '<ul class="mb-0">';
                                        for (const [f, m] of Object.entries(j.errors || {})) {
                                            html += `<li><strong>${f}:</strong> ${m}</li>`;
                                        }
                                        html += '</ul>';
                                        errorsAct.innerHTML = html;
                                        errorsAct.classList.remove('d-none');
                                    });
                                } else {
                                    console.error(err);
                                }
                            });
                    });

                    // Limpia errores al cerrar
                    modalActEl.addEventListener('hidden.bs.modal', () => {
                        errorsAct.classList.add('d-none');
                        errorsAct.innerHTML = '';
                    });
                }
            });

            // Funciones auxiliares
            function asignarEventosEliminar() {
                document.querySelectorAll('.eliminar-actividad, .eliminar-colaborador').forEach(boton => {
                    boton.removeEventListener('click', handleEliminarClick);
                    boton.addEventListener('click', handleEliminarClick);
                });
            }

            function handleEliminarClick(e) {
                e.preventDefault();
                idAEliminar = this.dataset.id;
                tipoAEliminar = this.dataset.tipo;
                viajeId = this.dataset.viajeId || null;

                // Encuentra el elemento más cercano a eliminar
                if (tipoAEliminar === 'actividad') {
                    elementoAEliminar = this.closest('.list-group-item');
                } else if (tipoAEliminar === 'colaborador') {
                    elementoAEliminar = this.closest('.col-md-6');
                }

                modalBodyText.textContent = tipoAEliminar === 'actividad'
                    ? "¿Estás seguro de que deseas eliminar esta actividad?"
                    : "¿Estás seguro de que deseas eliminar a este colaborador?";

                modalEliminar.show();
            }

            function showAlert(type, message) {
                // Elimina alertas anteriores
                const oldAlert = document.getElementById('dynamic-alert');
                if (oldAlert) {
                    oldAlert.remove();
                }

                // Crea el elemento de alerta
                const alertDiv = document.createElement('div');
                alertDiv.id = 'dynamic-alert';
                alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                alertDiv.style.cssText = 'top: 20px; left: 50%; transform: translateX(-50%); z-index: 1100;';

                alertDiv.innerHTML = `
            <i class="fas fa-${type === 'danger' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

                // Añade al cuerpo del documento
                document.body.appendChild(alertDiv);

                // Elimina automáticamente después de 5 segundos
                setTimeout(() => {
                    const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                    alert.close();
                }, 5000);
            }

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            document.getElementById('likesModal').addEventListener('hidden.bs.modal', function () {
                // Espera a que termine la animación del modal
                setTimeout(() => {
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }

                    document.body.classList.remove('modal-open');
                    document.body.style.paddingRight = '';
                    document.body.style.overflow = '';
                }, 10);

            });

            document.getElementById('generarItinerarioBtn').addEventListener('click', () => {
                if (actividadesData.length === 0) {
                    showAlert('warning', 'No hay actividades para generar PDF.');
                    return;
                }

                const {jsPDF} = window.jspdf;
                const doc = new jsPDF({unit: 'pt', format: 'a4'});
                const margin = 40;
                const lineHeight = 14;
                const pageHeight = doc.internal.pageSize.height;
                let cursorY = margin;

                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(`Itinerario de viaje: {{ viaje.nombre }}`, margin, cursorY);
                cursorY += lineHeight * 2;

                doc.setFontSize(12);
                actividadesData.forEach((act, idx) => {
                    const textFecha = act.fecha;
                    const textTitulo = `Nombre: ${act.titulo}`;
                    const textDesc = `Descripción: ${act.descripcion}`;

                    // Si nos pasamos de la página, agregar nueva
                    if (cursorY + lineHeight * 3 > pageHeight - margin) {
                        doc.addPage();
                        cursorY = margin;
                        doc.setFontSize(12);
                    }

                    doc.setFont(undefined, 'bold');
                    doc.text(textFecha, margin, cursorY);
                    cursorY += lineHeight;

                    doc.setFont(undefined, 'normal');
                    doc.text(textTitulo, margin + 10, cursorY);
                    cursorY += lineHeight;

                    // Para la descripción, cortamos en líneas si es muy larga
                    const splitDesc = doc.splitTextToSize(textDesc, doc.internal.pageSize.width - margin * 2 - 10);
                    doc.text(splitDesc, margin + 10, cursorY);
                    cursorY += lineHeight * splitDesc.length + lineHeight;

                    // Línea separadora
                    doc.setDrawColor(200);
                    doc.setLineWidth(0.5);
                    doc.line(margin, cursorY, doc.internal.pageSize.width - margin, cursorY);
                    cursorY += lineHeight;
                });

                doc.save(`Itinerario viaje {{ viaje.nombre }}.pdf`);
            });

        </script>
    {% endblock %}
{% endblock %}